// SQLite 版本的 Prisma Schema
// 从 PostgreSQL 迁移到 SQLite

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// 用户模型
model User {
  id        String   @id @default(cuid())
  email     String?  @unique
  username  String?  @unique
  password  String?  // 密码哈希，访客用户可以为空
  avatar    String?
  role      String   @default("USER") // ADMIN, USER, GUEST (SQLite 不支持 enum)
  isActive  Boolean  @default(true)
  canShareAccessCode Boolean @default(true)

  // 密码重置相关
  resetToken String?
  resetTokenExpiry DateTime?

  // 邀请码相关
  invitedBy String?
  usedInviteCode String?

  // 访客相关
  usedAccessCode String?
  hostUserId String?
  hostUser   User?    @relation("GuestHost", fields: [hostUserId], references: [id])
  guests     User[]   @relation("GuestHost")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 关联关系
  conversations     Conversation[]
  messages          Message[]
  settings          UserSettings?
  tokenUsage        TokenUsage[]
  permissions       UserPermission?
  generatedInvites  InviteCode[]
  generatedAccessCodes AccessCode[]
  modelGroupOrders ModelGroupOrder[]

  @@map("users")
}

// 用户设置
model UserSettings {
  id               String  @id @default(cuid())
  userId           String  @unique
  defaultModelId   String?
  theme            String  @default("light")
  language         String  @default("zh-CN")
  enableMarkdown   Boolean @default(true)
  enableLatex      Boolean @default(true)
  enableCodeHighlight Boolean @default(true)
  messagePageSize  Int     @default(50)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_settings")
}

// 系统设置模型
model SystemSettings {
  id    String @id @default(cuid())
  key   String @unique
  value String
  type  String @default("string")
  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("system_settings")
}

// AI 服务提供商
model Provider {
  id          String   @id @default(cuid())
  name        String   @unique
  displayName String
  baseUrl     String?
  apiKey      String?
  isEnabled   Boolean  @default(true)
  order       Int      @default(0)
  icon        String?
  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  models        Model[]
  conversations Conversation[]
  messages      Message[]
  tokenUsage    TokenUsage[]

  @@map("providers")
}

// AI 模型
model Model {
  id          String   @id @default(cuid())
  providerId  String
  modelId     String
  name        String
  description String?
  isEnabled   Boolean  @default(true)
  order       Int      @default(0)
  group       String?

  // 模型配置
  maxTokens      Int?
  temperature    Float?
  topP           Float?
  frequencyPenalty Float?
  presencePenalty  Float?

  // 价格设置
  pricingType     String  @default("token")
  inputPrice      Float   @default(2.0)
  outputPrice     Float   @default(8.0)
  usagePrice      Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  provider      Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  conversations Conversation[]
  messages      Message[]
  tokenUsage    TokenUsage[]

  @@unique([providerId, modelId])
  @@map("models")
}

// 对话
model Conversation {
  id          String   @id @default(cuid())
  userId      String
  providerId  String
  modelId     String
  title       String
  isArchived  Boolean  @default(false)
  isPinned    Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user       User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  provider   Provider     @relation(fields: [providerId], references: [id])
  model      Model        @relation(fields: [modelId], references: [id])
  messages   Message[]
  tokenUsage TokenUsage[]

  @@map("conversations")
}

// 消息
model Message {
  id             String   @id @default(cuid())
  conversationId String
  userId         String
  providerId     String
  modelId        String
  role           String
  content        String
  rawContent     String?
  isEdited       Boolean  @default(false)
  isDeleted      Boolean  @default(false)

  finishReason   String?
  tokenUsage     String?  // SQLite 使用 TEXT 存储 JSON

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  provider     Provider     @relation(fields: [providerId], references: [id])
  model        Model        @relation(fields: [modelId], references: [id])

  @@map("messages")
}

// 邀请码模型
model InviteCode {
  id          String   @id @default(cuid())
  code        String   @unique
  createdBy   String
  isUsed      Boolean  @default(false)
  usedBy      String?
  usedAt      DateTime?
  expiresAt   DateTime?
  maxUses     Int      @default(1)
  currentUses Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  creator User @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  @@map("invite_codes")
}

// 访问码模型
model AccessCode {
  id          String   @id @default(cuid())
  code        String   @unique
  createdBy   String
  isActive    Boolean  @default(true)
  expiresAt   DateTime?
  maxUses     Int?
  currentUses Int      @default(0)

  allowedModelIds String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  creator User @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  @@map("access_codes")
}

// Token使用统计
model TokenUsage {
  id             String   @id @default(cuid())
  userId         String
  conversationId String?
  messageId      String?
  providerId     String
  modelId        String

  promptTokens     Int
  completionTokens Int
  totalTokens      Int

  isEstimated      Boolean @default(false)
  inputChars       Int?
  outputChars      Int?

  cost             Float?

  createdAt DateTime @default(now())

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversation Conversation? @relation(fields: [conversationId], references: [id], onDelete: SetNull)
  provider     Provider      @relation(fields: [providerId], references: [id])
  model        Model         @relation(fields: [modelId], references: [id])

  @@map("token_usage")
}

// 用户权限模型
model UserPermission {
  id             String    @id @default(cuid())
  userId         String    @unique
  permissions    String    @default("[]") // SQLite 使用 TEXT 存储 JSON

  // 模型访问权限
  allowedModelIds String?   // 允许使用的模型ID，逗号分隔
  canShareAccess  Boolean   @default(true) // 是否可以分享访问权限
  isActive        Boolean   @default(true) // 权限是否启用

  // Token 使用限制
  limitType      String    @default("none")
  limitPeriod    String    @default("monthly")
  tokenLimit     Int?
  costLimit      Float?
  tokenUsed      Int       @default(0)
  lastResetAt    DateTime  @default(now())

  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_permissions")
}

// 模型分组排序配置
model ModelGroupOrder {
  id          String   @id @default(cuid())
  userId      String
  groupName   String
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, groupName])
  @@index([userId])
  @@index([order])
  @@map("model_group_orders")
}
